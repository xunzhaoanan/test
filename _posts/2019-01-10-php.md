---
layout: post
title:  "PHP框架开发思路"
date:   2018-07-10 14:00:00
categories: PHP
tags: PHP
excerpt: 在用了一段时间PHP框架后，自己也想着手写一个精简版框架。前后断断续续经过大半年时间，终于有了小成果，并且成功在公司的项目中跑起来了。这里简单聊聊编写一个PHP框架的思路，欢迎交流。
---


* content
{:toc}

在用了一段时间PHP框架后，自己也想着手写一个精简版框架。
前后断断续续经过大半年时间，终于有了小成果，并且成功在公司的项目中跑起来了。
这里简单聊聊编写一个PHP框架的思路，欢迎交流。
（此篇文章以YII2框架为参考）。

## 初始化功能

框架里最重要的就是核心类（core class）了，类似于[YII2](https://www.yiichina.com/)框架里的Yii.php文件.
核心类应该包含框架最基本的功能，每次程序运行的时候，都会加载这个文件，一般在入口文件中被加载（带上配置参数）。
下面聊聊核心类初始化需要的一些功能。

### 初始化主要功能

* 定义系统默认常量。

    我们经常在入口文件中的第一行就看到开始一些系统常量的定义，在核心类中，可以定义这些常量的默认值。

* 类的自动加载

    在使用PHP主流框架的过程中，当需要使用某个类的某个方法时，往往只需要**use**一下目标类的命名空间就行了，而不需要引入目标文件，
    这在原生环境中是绝对不行的。那么框架是如何做到的呢？答案就是用到了PHP中的一个函数:[spl_autoload_register](http://www.php.net/manual/zh/function.spl-autoload-register.php)。
    在YII2中，是这样使用的：
    
    ```php
    spl_autoload_register(['Yii', 'autoload'], true, true);
    ```
        
    这句话的意思是，当使用一个没有包含的类方法时，框架会定位到Yii类中的`autoload()`方法。在此方法中，把需要的类包含进来就可以了。   
    此函数在手册中有详细的说明，在使用这个函数后，我们也能像其他框架那样自由使用类了。
    
* 加载配置&&组件

    一般情况下，我们会有一个配置文件，此配置文件一般以数组形式存放系统变量和组件。
    在入口文件实例化核心类时，此时可以在初始化的时候加载这个配置文件，存放在类变量里，这样在程序任何地方，都可以使用到这个配置变量。
    普通配置的使用比较简单，无非就是引用核心类的某个属性，这里重点说一下组件的加载和使用。
    参考一下YII2，一个典型的例子就是**数据库配置**。
    
    我们写框架的时候，如果有组件这个概念，那么在使用框架的时候会方便许多，让我们先看看组件是怎么定义的：
    
    ```php
    'components' => [
            'cache' => [
                'class' => 'yii\caching\FileCache',
            ],
            'db' => [
                'class' => 'yii\db\Connection',
                'dsn' => 'mysql:host=127.0.0.1;dbname=test',
                'username' => 'root',
                'password' => '',
                'charset' => 'utf8',
            ],
        ]
    ```
    
    这是YII2框架中组件定义的方法，这个数组会在初始化的时候触发`setComponents()`函数，此函数如下：
    
    ```php
    public function setComponents($components)
    {
        foreach ($components as $id => $component) {
            $this->set($id, $component);
        }
    }
    ```
    
    $components变量就是上面定义的数组，再让我们看看此函数的`set()`方法做了什么事情：
    
    ```php
    public function set($id, $definition)
    {
        if ($definition === null) {
            unset($this->_components[$id], $this->_definitions[$id]);
            return;
        }

        unset($this->_components[$id]);

        if (is_object($definition) || is_callable($definition, true)) {
            // an object, a class name, or a PHP callable
            $this->_definitions[$id] = $definition;
        } elseif (is_array($definition)) {
            // a configuration array
            if (isset($definition['class'])) {
                $this->_definitions[$id] = $definition;
            } else {
                throw new InvalidConfigException("The configuration for the \"$id\" component must contain a \"class\" element.");
            }
        } else {
            throw new InvalidConfigException("Unexpected configuration type for the \"$id\" component: " . gettype($definition));
        }
    }
    ```
    
    这里会把我们的组件数组以键值对的方式放在ServiceLocator类的`_definitions`属性中，
    当我们需要用到数据库的时候，通常会调用这个方法`Yii::$app->db`，其实Yii类中是不存在db这个变量的，此时会调用
    核心类的`__get()`魔术方法，在`__get()`里调用ServiceLocator类`get()`方法。
    
    ```php
    public function get($id, $throwException = true)
    {
        if (isset($this->_components[$id])) {
            return $this->_components[$id];
        }

        if (isset($this->_definitions[$id])) {
            $definition = $this->_definitions[$id];
            if (is_object($definition) && !$definition instanceof Closure) {
                return $this->_components[$id] = $definition;
            } else {
                return $this->_components[$id] = Yii::createObject($definition);
            }
        } elseif ($throwException) {
            throw new InvalidConfigException("Unknown component ID: $id");
        } else {
            return null;
        }
    }
    ```
    
    这个方法通过获取初始化时注册在`_definitions`中的值，实例化了数据库数组中**class**元素值的类，也就是`yii\db\Connection`类，并且返回到`Yii::$app->db`，
    从而我们就可以通过用`Yii::$app->db`调用`yii\db\Connection`类中的方法。其他组件也是类似这样去获取的。
    
    所以，我们在自己的框架中也可以像YII2这样引入组件功能，可以不用那么复杂，先写个简单的。
    用组件可以使配置统一管理，代码更加整洁；同时使OOP思想更加深刻，特别是在自己写框架时。
    
## run()
    
在初始化核心类之后，就要执行`run()`方法了，此方法一般也是在入口文件调用，每次运行代码的时候都会执行一次，下面我们看看`run`方法都有哪些功能。

### run()方法主要功能

* 解析请求

    要执行某个控制器里的某个方法，首先要做的是根据url解析到相应的方法上。解析请求看起来简单，其实根据框架功能丰富程度，也许会很复杂。
    假设我们的访问地址如下：
    
    > http://127.0.0.1/index/index?id=1
    
    设计解析请求的思路大致如下：
        
    1. 获取除主机名称和查询参数的值，即`index/index`。
    2. 获取请求url上的请求参数，数组形式，即`Array([id] => 1)`。
    
    
